<link rel="stylesheet" href="/styles/LoginBD.css">

<form id="registerForm" action="/register" method="POST" class="form-box">
    <h2>Registro</h2>
    <input type="text" name="nombre" placeholder="Nombre" required>
    <input type="email" name="email" placeholder="Email" required>
    <input type="password" name="password" placeholder="Contraseña" required>
    
    <!-- Nuevo campo para seleccionar rol -->
    <div class="form-group">
        <label for="role">Tipo de usuario:</label>
        <select name="role_id" id="role" class="form-control" required>
            <option value="">Seleccione un rol</option>
            <option value="2">Usuario Normal</option>
            <option value="1">Administrador</option>
        </select>
    </div>

    <!-- Google reCAPTCHA -->
    <div class="g-recaptcha" data-sitekey="<%= recaptchaSiteKey %>"></div>
    <div id="errorMessage" class="error-message">
        <span id="errorText"></span>
    </div>

    <button class="boton" type="submit">Registrarse</button>
    
    <div class="url-log">
        <p>¿Ya tienes cuenta?</p> <a href="/login" class="a-href">Inicia sesión</a>
    </div>
</form>

<!-- Script de Google reCAPTCHA -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<!-- Script para manejar el formulario -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        function showErrorMessage(message) {
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            if (errorMessage && errorText) {
                errorText.textContent = message;
                errorMessage.style.display = 'block';
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 1500);
            }
        }

        const registerForm = document.getElementById('registerForm');
        if (registerForm) {
            registerForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const recaptchaResponse = grecaptcha.getResponse();
                if (!recaptchaResponse) {
                    showErrorMessage('Por favor, completa el reCAPTCHA.');
                    return;
                }

                // Verificar que se haya seleccionado un rol
                const roleId = document.getElementById('role').value;
                if (!roleId) {
                    showErrorMessage('Por favor, selecciona un rol.');
                    return;
                }

                const formData = {
                    nombre: event.target.nombre.value,
                    email: event.target.email.value,
                    password: event.target.password.value,
                    role_id: roleId,
                    'g-recaptcha-response': recaptchaResponse,
                };

                try {
                    const response = await fetch('/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData),
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        window.location.href = result.redirect;
                    } else {
                        showErrorMessage(result.error || 'Error en el registro.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showErrorMessage('Error interno del servidor.');
                }
            });
        }
    });
</script>
